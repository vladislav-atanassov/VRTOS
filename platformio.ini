; /*******************************************************************************
;  * File: platformio.ini
;  * Description: PlatformIO Configuration for RTOS Project
;  * Author: Student
;  * Date: 2025
;  ******************************************************************************/

[platformio]
default_envs = basic_blinky

; --- Port Layer (one section per architecture) ---

[cortex_m4]
build_flags =
    -I src/port/cortex_m4/
    -mfpu=fpv4-sp-d16
    -mfloat-abi=softfp
port_src_filter =
    -<port/>
    +<port/common/>
    +<port/cortex_m4/>

; Common configuration
[env]
platform = ststm32
board = nucleo_f446re
framework = stm32cube

; Build configuration
build_flags = 
    ; Port layer (architecture-specific)
    ${cortex_m4.build_flags}

    ; Include directories
    -I include/
    -I include/VRTOS/
    -I config/stm32f446re/
    -I src/core/
    -I src/scheduler
    -I src/scheduler/scheduler_types
    -I src/task/
    -I src/utils/
    -I src/port/common/
    -I src/sync/
    -I src/timer/
    -I src/memory/

    -D CMAKE_EXPORT_COMPILE_COMMANDS=1
    
    ; Compiler definitions
    -D STM32F446xx
    -D USE_HAL_DRIVER
    -D RTOS_TARGET_STM32F446RE
    
    ; Optimization and debug
    -O2
    -g3
    -Wall
    -Wextra
    -Wno-unused-parameter
    
    ; Linker flags
    -Wl,--gc-sections
    -Wl,--print-memory-usage
    -D VECT_TAB_OFFSET=0x0

; Upload and debug configuration
upload_protocol = stlink
debug_tool = stlink
debug_init_break = tbreak main
monitor_speed = 115200

; Custom build targets
extra_scripts = 
    pre:tools/scripts/pre_build.py
    post:tools/scripts/post_build.py

; --- EXAMPLES ---

[env:basic_blinky]
build_src_filter = +<*> -<examples/> +<examples/basic_blinky/> ${cortex_m4.port_src_filter}

[env:producer_consumer]
build_src_filter = +<*> -<examples/> +<examples/producer_consumer/> ${cortex_m4.port_src_filter}

[env:profiling_demo]
build_src_filter = +<*> -<examples/> +<examples/profiling_demo/> ${cortex_m4.port_src_filter}

[env:fpu_context_test]
build_src_filter = +<*> -<examples/> +<examples/fpu_context_test/> ${cortex_m4.port_src_filter}

; --- INTEGRATION TESTS ---

[env:test_mutex_priority]
build_src_filter = +<*> -<examples/> +<../tests/integration/test_mutex_priority_inheritance.c>

[env:test_semaphore_pc]
build_src_filter = +<*> -<examples/> +<../tests/integration/test_semaphore_producer_consumer.c>

[env:test_queue_blocking]
build_src_filter = +<*> -<examples/> +<../tests/integration/test_queue_blocking.c>

[env:test_states]
build_src_filter = +<*> -<examples/> +<../tests/integration/test_state_transitions.c>

; --- SCHEDULER TESTS ---
; These tests override RTOS_SCHEDULER_TYPE via build_flags

[env:test_scheduler_rr]
build_src_filter = +<*> -<examples/> +<../tests/scheduler/test_scheduler_rr.c>
build_flags = 
    ${env.build_flags}
    -I config/test/
    -D RTOS_SCHEDULER_TYPE=RTOS_SCHEDULER_ROUND_ROBIN

[env:test_scheduler_preemptive]
build_src_filter = +<*> -<examples/> +<../tests/scheduler/test_scheduler_preemptive.c>
build_flags = 
    ${env.build_flags}
    -I config/test/
    -D RTOS_SCHEDULER_TYPE=RTOS_SCHEDULER_PREEMPTIVE_SP

[env:test_scheduler_cooperative]
build_src_filter = +<*> -<examples/> +<../tests/scheduler/test_scheduler_cooperative.c>
build_flags = 
    ${env.build_flags}
    -I config/test/
    -D RTOS_SCHEDULER_TYPE=RTOS_SCHEDULER_COOPERATIVE
